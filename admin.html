<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Pizzaria Maluca</title>
    <style>
        body { background: #121212; font-family: sans-serif; margin: 0; padding: 0; }
        .admin-container { padding: 15px; max-width: 600px; margin: auto; color: white; box-sizing: border-box; }
        header { text-align: center; margin-bottom: 20px; position: relative; }
        .btn-logout { background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; position: absolute; right: 0; top: 0; font-size: 14px; }
        .status-badge { padding: 15px; text-align: center; border-radius: 5px; margin-bottom: 20px; font-weight: bold; text-transform: uppercase; font-size: 14px; }
        .aberto { background: #2ecc71; box-shadow: 0 0 10px rgba(46, 204, 113, 0.3); }
        .fechado { background: #e74c3c; box-shadow: 0 0 10px rgba(231, 76, 60, 0.3); }
        .form-group { margin-bottom: 15px; display: flex; flex-direction: column; }
        label { font-size: 14px; margin-bottom: 5px; color: #aaa; }
        input, select { padding: 12px; border-radius: 5px; border: 1px solid #333; background: #2a2a2a; color: white; font-size: 16px; }
        .grid-precos { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .btn-salvar { background: #2ecc71; color: white; padding: 18px; border: none; border-radius: 5px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 20px; font-size: 16px; transition: 0.2s; }
        h3 { margin-top: 25px; border-bottom: 1px solid #333; padding-bottom: 5px; font-size: 18px; color: #e74c3c; }
        @media (max-width: 400px) { .grid-precos { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="admin-container">
        <header>
            <button class="btn-logout" onclick="logout()">Sair</button>
            <img src="img/pizzas/LOGO PIZZA.png" width="80" style="margin-top: 10px;">
            <h1 style="font-size: 22px;">Painel de Controle</h1>
        </header>

        <div id="status-atual" class="status-badge">Conectando ao Banco...</div>

        <form id="form-admin">
            <div class="form-group">
                <label>WhatsApp (com DDD):</label>
                <input type="text" id="whatsapp" placeholder="Ex: 5511999999999">
            </div>

            <div class="form-group">
                <label>Taxa de Entrega (R$):</label>
                <input type="number" step="0.01" id="taxaEntrega">
            </div>

            <h3>Preços das Pizzas (R$)</h3>
            <div class="grid-precos">
                <div class="form-group"><label>Pizza P:</label><input type="number" step="0.01" id="precoP"></div>
                <div class="form-group"><label>Pizza M:</label><input type="number" step="0.01" id="precoM"></div>
                <div class="form-group"><label>Pizza G:</label><input type="number" step="0.01" id="precoG"></div>
                <div class="form-group"><label>Pizza F:</label><input type="number" step="0.01" id="precoF"></div>
            </div>

            <h3>Preços das Bebidas (R$)</h3>
            <div class="grid-precos">
                <div class="form-group"><label>Água sem Gás:</label><input type="number" step="0.01" id="aguasemGas"></div>
                <div class="form-group"><label>Água com Gás:</label><input type="number" step="0.01" id="AguacomGas"></div>
                <div class="form-group"><label>Refri 1Lt:</label><input type="number" step="0.01" id="refri1l"></div>
                <div class="form-group"><label>Refri 2Lt:</label><input type="number" step="0.01" id="refri2l"></div>
                <div class="form-group"><label>Suco sem Leite:</label><input type="number" step="0.01" id="sucosemLeite"></div>
                <div class="form-group"><label>Suco com Leite:</label><input type="number" step="0.01" id="sucocomLeite"></div>
            </div>

            <h3>Segurança do Painel</h3>
            <div class="form-group">
                <label>Nova Senha de Acesso (6 números):</label>
                <input type="password" id="novaSenha" placeholder="Digite para mudar ou deixe vazio" maxlength="6">
            </div>

            <button type="button" class="btn-salvar" onclick="salvarConfiguracoes()">SALVAR NO BANCO DE DADOS</button>
        </form>
    </div>

    <script>
        if (localStorage.getItem('admin_logado') !== 'true') { window.location.href = "login.html"; }
        function logout() { localStorage.removeItem('admin_logado'); window.location.href = "login.html"; }

        // LINK CORRIGIDO PARA O SEU BACKEND NO RENDER
        const API_URL = "https://pizzaria-maluca.onrender.com/api/config";
        let senhaAtualServidor = "";

        async function carregarDados() {
            const badge = document.getElementById('status-atual');
            try {
                const res = await fetch(API_URL);
                if (!res.ok) throw new Error("Falha na resposta do servidor");
                
                const data = await res.json();
                
                senhaAtualServidor = data.senhaAdmin || "123456";

                document.getElementById('whatsapp').value = data.whatsapp || "";
                document.getElementById('taxaEntrega').value = data.taxaEntrega || 0;
                
                if(data.precosPizzas) {
                    document.getElementById('precoP').value = data.precosPizzas.p || 0;
                    document.getElementById('precoM').value = data.precosPizzas.m || 0;
                    document.getElementById('precoG').value = data.precosPizzas.g || 0;
                    document.getElementById('precoF').value = data.precosPizzas.f || 0;
                }

                if(data.precosBebidas) {
                    document.getElementById('aguasemGas').value = data.precosBebidas.agua || 0;
                    document.getElementById('AguacomGas').value = data.precosBebidas.aguaGas || 0;
                    document.getElementById('refri1l').value = data.precosBebidas.refri1l || 0;
                    document.getElementById('refri2l').value = data.precosBebidas.refri || 0;
                    document.getElementById('sucosemLeite').value = data.precosBebidas.sucoSimples || 0;
                    document.getElementById('sucocomLeite').value = data.precosBebidas.sucoLeite || 0;
                }

                badge.innerText = `✅ Sistema Online (MongoDB)`;
                badge.className = `status-badge aberto`;
            } catch (error) { 
                console.error("Erro ao carregar:", error);
                badge.innerText = "❌ ERRO DE CONEXÃO";
                badge.className = `status-badge fechado`;
            }
        }

        async function salvarConfiguracoes() {
            const btn = document.querySelector('.btn-salvar');
            const novaSenhaCampo = document.getElementById('novaSenha').value;
            
            btn.innerText = "GRAVANDO NO BANCO...";
            btn.disabled = true;

            const config = {
                whatsapp: document.getElementById('whatsapp').value,
                taxaEntrega: parseFloat(document.getElementById('taxaEntrega').value) || 0,
                precosPizzas: {
                    p: parseFloat(document.getElementById('precoP').value) || 0,
                    m: parseFloat(document.getElementById('precoM').value) || 0,
                    g: parseFloat(document.getElementById('precoG').value) || 0,
                    f: parseFloat(document.getElementById('precoF').value) || 0
                },
                precosBebidas: {
                    agua: parseFloat(document.getElementById('aguasemGas').value) || 0,
                    aguaGas: parseFloat(document.getElementById('AguacomGas').value) || 0,
                    refri1l: parseFloat(document.getElementById('refri1l').value) || 0,
                    refri: parseFloat(document.getElementById('refri2l').value) || 0,
                    sucoSimples: parseFloat(document.getElementById('sucosemLeite').value) || 0,
                    sucoLeite: parseFloat(document.getElementById('sucocomLeite').value) || 0
                },
                senhaAdmin: novaSenhaCampo.trim() !== "" ? novaSenhaCampo : senhaAtualServidor
            };

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                if(res.ok) { 
                    alert("Dados salvos com segurança no MongoDB!");
                    document.getElementById('novaSenha').value = "";
                    carregarDados(); 
                } else {
                    alert("O servidor recusou os dados.");
                }
            } catch (error) { 
                alert("Erro ao salvar no banco! Verifique sua conexão."); 
            } finally { 
                btn.innerText = "SALVAR NO BANCO DE DADOS"; 
                btn.disabled = false; 
            }
        }
        window.onload = carregarDados;
    </script>
</body>
</html>