<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Administrativo - Pizzaria Maluca</title>
    <style>
        body, html {
            height: 100%;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #121212;
            font-family: sans-serif;
        }
        .login-box { 
            width: 90%; 
            max-width: 350px; 
            padding: 30px; 
            background: #1e1e1e; 
            border-radius: 10px; 
            text-align: center; 
            color: white; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); 
        }
        input { 
            width: 100%; 
            padding: 12px; 
            margin: 10px 0; 
            border-radius: 5px; 
            border: none; 
            box-sizing: border-box; 
            background: #2a2a2a; 
            color: white; 
            text-align: center; 
            font-size: 16px; 
        }
        button { 
            width: 100%; 
            padding: 12px; 
            background: #e74c3c; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-weight: bold; 
            margin-top: 10px; 
            transition: 0.3s; 
        }
        button:hover { background: #c0392b; }
        .link-recuperar { 
            display: block; 
            margin-top: 15px; 
            color: #bbb; 
            font-size: 13px; 
            text-decoration: none; 
            cursor: pointer; 
        }
        .hidden { display: none; }
        .instrucao { 
            font-size: 12px; 
            color: #aaa; 
            margin-bottom: 10px; 
            line-height: 1.4;
        }
        img { margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="login-box">
        <img src="img/pizzas/LOGO PIZZA.png" width="80" alt="Logo">
        
        <div id="tela-login">
            <h2>Painel Admin</h2>
            <input type="password" id="senha" placeholder="Senha de 6 n칰meros" maxlength="6" inputmode="numeric">
            <button onclick="verificarSenha()">ENTRAR</button>
            <span class="link-recuperar" onclick="mostrarRecuperacao()">Esqueci a senha</span>
        </div>

        <div id="tela-recuperar" class="hidden">
            <h2>Recupera칞칚o</h2>
            <p class="instrucao">Enviaremos um c칩digo de seguran칞a para o WhatsApp da pizzaria.</p>
            <button style="background: #25d366;" onclick="enviarCodigoZap()">RECEBER C칍DIGO NO WHATSAPP</button>
            
            <div id="area-validacao" class="hidden">
                <input type="text" id="codigo-input" placeholder="Digite o c칩digo" maxlength="6" inputmode="numeric">
                <button onclick="validarCodigo()">VALIDAR C칍DIGO</button>
            </div>
            <span class="link-recuperar" onclick="voltarLogin()">Voltar ao login</span>
        </div>

        <div id="tela-nova-senha" class="hidden">
            <h2>Nova Senha</h2>
            <p class="instrucao">Crie sua nova senha de 6 n칰meros:</p>
            <input type="password" id="nova-senha" placeholder="Nova senha" maxlength="6" inputmode="numeric">
            <input type="password" id="confirma-senha" placeholder="Confirme a nova senha" maxlength="6" inputmode="numeric">
            <button style="background: #2ecc71;" onclick="salvarNovaSenha()">DEFINIR NOVA SENHA</button>
        </div>
    </div>

    <script>
        // URL base do seu servidor backend
        const BASE_API = "https://pizzaria-maluca.onrender.com/api";
        let codigoSegurancaGerado = null;

        function mostrarRecuperacao() {
            document.getElementById('tela-login').classList.add('hidden');
            document.getElementById('tela-recuperar').classList.remove('hidden');
        }

        function voltarLogin() { location.reload(); }

        async function verificarSenha() {
            const senhaDigitada = document.getElementById('senha').value;
            try {
                const res = await fetch(`${BASE_API}/config`);
                const config = await res.json();
                
                // Ajustado para buscar 'senhaAdmin' conforme o MongoDB
                if(senhaDigitada === config.senhaAdmin) {
                    localStorage.setItem('admin_logado', 'true');
                    window.location.href = "admin.html";
                } else { 
                    alert("Senha incorreta!"); 
                }
            } catch (err) {
                alert("Erro ao conectar com o servidor. Verifique se o backend est치 ativo.");
            }
        }

        async function enviarCodigoZap() {
            try {
                const res = await fetch(`${BASE_API}/config`);
                const config = await res.json();
                codigoSegurancaGerado = Math.floor(100000 + Math.random() * 900000);
                const msg = `游댏 *PIZZARIA MALUCA*\n\nSeu c칩digo para redefinir a senha 칠: *${codigoSegurancaGerado}*`;
                window.open(`https://api.whatsapp.com/send?phone=${config.whatsapp}&text=${encodeURIComponent(msg)}`);
                document.getElementById('area-validacao').classList.remove('hidden');
            } catch (err) {
                alert("Erro ao buscar dados do WhatsApp.");
            }
        }

        function validarCodigo() {
            const input = document.getElementById('codigo-input').value;
            if(input == codigoSegurancaGerado) {
                document.getElementById('tela-recuperar').classList.add('hidden');
                document.getElementById('tela-nova-senha').classList.remove('hidden');
            } else { 
                alert("C칩digo inv치lido!"); 
            }
        }

        async function salvarNovaSenha() {
            const nova = document.getElementById('nova-senha').value;
            const confirma = document.getElementById('confirma-senha').value;
            
            if(nova.length !== 6 || isNaN(nova)) return alert("A senha deve ter 6 n칰meros!");
            if(nova !== confirma) return alert("As senhas n칚o coincidem!");

            try {
                // Link corrigido para a rota de redefinir-senha
                const res = await fetch(`${BASE_API}/redefinir-senha`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ novaSenha: nova })
                });

                if(res.ok) {
                    alert("Senha atualizada com sucesso! Fa칞a login agora.");
                    location.reload();
                } else {
                    const textoErro = await res.text();
                    alert("Erro do servidor: " + textoErro);
                }
            } catch (err) {
                console.error(err);
                alert("Erro ao salvar nova senha. Verifique sua conex칚o.");
            }
        }
    </script>
</body>
</html>